package dev._2lstudios.exploitfixer.managers;

import java.util.Collection;
import java.util.HashMap;
import java.util.Iterator;
import java.util.Map;
import java.util.UUID;
import java.util.concurrent.ConcurrentHashMap;

import org.bukkit.Server;
import org.bukkit.entity.Player;
import org.bukkit.plugin.Plugin;

import dev._2lstudios.exploitfixer.exploit.BukkitExploitPlayer;
import dev._2lstudios.exploitfixer.exploit.ExploitPlayer;

public class ExploitPlayerManager {
	private Plugin plugin;
	private Server server;
	private ModuleManager moduleManager;
	private Map<UUID, BukkitExploitPlayer> exploitPlayers = new HashMap<>();
	private Collection<Player> closedInventories = ConcurrentHashMap.newKeySet();
	private int kicked = 0;

	ExploitPlayerManager(Plugin plugin, Server server, ModuleManager moduleManager) {
		this.plugin = plugin;
		this.server = server;
		this.moduleManager = moduleManager;
	}

	public BukkitExploitPlayer getIfPresent(UUID uuid) {
		return exploitPlayers.getOrDefault(uuid, null);
	}

	public BukkitExploitPlayer get(UUID uuid) {
		BukkitExploitPlayer exploitPlayer;

		if (exploitPlayers.containsKey(uuid)) {
			exploitPlayer = exploitPlayers.get(uuid);
		} else {
			exploitPlayer = new BukkitExploitPlayer(this.plugin, moduleManager, uuid);
			exploitPlayers.put(uuid, exploitPlayer);
		}

		return exploitPlayer;
	}

	public BukkitExploitPlayer get(Player player) {
		return get(player.getUniqueId());
	}

	public void remove(UUID uuid) {
		exploitPlayers.remove(uuid);
	}

	public void remove(Player player) {
		remove(player.getUniqueId());
	}

	public void reload() {
		exploitPlayers.clear();

		for (Player player : server.getOnlinePlayers()) {
			get(player);
		}
	}

	public int getSize() {
		return exploitPlayers.size();
	}

	public int getKicked() {
		return kicked;
	}

	public int addKicked() {
		return kicked++;
	}

	public void clearInventoryItems() {
		// Iterator for closed inventories
		Iterator<Player> iterator = closedInventories.iterator();

		// Iterate
		while (iterator.hasNext()) {
			Player player = iterator.next();

			// Check if player is online
			if (!player.isOnline()) {
				iterator.remove();
			} else {
				// Check if inventory is closed
				if (player.getOpenInventory() == null) {
					// Get the player
					ExploitPlayer exploitPlayer = get(player);

					// Check if exploitplayer exists
					if (exploitPlayer != null) {
						// Clear his items
						exploitPlayer.clearInventoryItems();
					}

					// Already clared, remove
					iterator.remove();
				}
			}
		}
	}

	public void setClosedInventory(Player player) {
		this.closedInventories.add(player);
	}
}
